<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Alpha Cuda Simul — Detail</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    nav { background:#343a40; padding:10px; display:flex; gap:20px; }
    nav a { color:#fff; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .container { padding:20px; }
    .toolbar { display:flex; align-items:center; gap:12px; margin:6px 0 14px 0; flex-wrap:wrap; }
    .toolbar label { font-size:12px; color:#333; }
    .toolbar input, .toolbar select, .toolbar button { padding:4px 6px; }
    .muted { color:#777; }
    table { width:100%; border-collapse: collapse; margin-top:8px; }
    th, td { border:1px solid #e1e1e1; padding:6px 8px; font-size:12px; }
    th { background:#f5f6f7; text-align:left; }
    tr:hover { background:#fafafa; }
    .right { text-align:right; }
    .nowrap { white-space: nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>

<nav>
  <a href="/">Server Monitor</a>
  <a href="/cuda">Alpha Cuda Simul</a>
  <a href="/simul">Simulation Regist</a>
  <a href="/paramset">Parameta Set Regist</a>
</nav>


<div class="container">
  <h4>Simulation Detail — simul_id: <span id="simulId">{{ simul_id }}</span></h4>

  <div class="toolbar">
    <label>Max Rows:
      <select id="limit">
        <option value="100">100</option>
        <option value="200" selected>200</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
      </select>
    </label>
    <label>Filter (case / params):
      <input type="text" id="filter" placeholder="">
    </label>
    <label>env_no:
      <input type="number" id="envNo" value="5" style="width:80px;">
    </label>
    <button id="reloadBtn">Reload</button>
    <span id="status" class="muted"></span>
  </div>

  <table id="detailTable">
    <thead>
      <tr>
        <th>#</th>
        <th class="nowrap">case_id</th>
        <th class="right nowrap">win_rate (%)</th>
        <th class="right nowrap">wins</th>
        <th class="right nowrap">trades</th>
        <th class="right nowrap">profit</th>
        <th>params</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- SQL 팝업 -->
<dialog id="sqlDialog" style="max-width:900px; width:90%;">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
    <b>Generated SQL</b>
    <div style="display:flex; gap:8px;">
      <button id="copySqlBtn">Copy</button>
      <button id="applySqlBtn">Apply</button>
      <button id="closeSqlBtn">Close</button>
    </div>
  </div>
  <textarea id="sqlText" style="width:100%; height:240px; font-family:ui-monospace,Consolas,Monaco,monospace; font-size:12px;"></textarea>
</dialog>

<script>
// simul_id 확보 (템플릿/경로/쿼리)
let simulId = Number(document.getElementById('simulId').textContent);
if (!Number.isFinite(simulId) || simulId < 0) {
  const path = window.location.pathname.split('/').filter(Boolean);
  const fromPath = Number(path[path.length - 1]);
  if (Number.isFinite(fromPath) && fromPath > 0) simulId = fromPath;
}
if (!Number.isFinite(simulId) || simulId < 0) {
  const qp = new URLSearchParams(window.location.search);
  const fromQ = Number(qp.get('simul_id'));
  if (Number.isFinite(fromQ) && fromQ > 0) simulId = fromQ;
}

// 평균기간 슬롯 매핑 (0-based index)
const PERIODS = [3,5,7,10,15,20,25,30,35,40,45,50,55,60,70,80,120];
// avg 변환 대상
const AVG_TARGETS = new Set([
  "s1m1_entry_avg1","s1m1_entry_avg2",
  "s1m1_congest_avg1","s1m1_congest_avg2",
  "s1m1_congest2_avg1","s1m1_congest2_avg2",
  "s1m1_congest3_avg1","s1m1_congest3_avg2",
]);

function fmtNum(n){
  if (n === null || n === undefined) return null;
  if (Number.isInteger(n)) return String(n);
  const s = Number(n).toFixed(6);
  return s.replace(/\.0+$/,'').replace(/(\.\d*[1-9])0+$/,'$1');
}

// p{i}_name / p{i}_val 우선 사용, 없으면 param_summary 파싱
function buildParamMap(item){
  const map = {};
  let foundAny = false;
  for (let i=1;i<=20;i++){
    const nk = 'p' + i + '_name', vk = 'p' + i + '_val';
    if (nk in item || vk in item){
      const name = item[nk];
      const val  = item[vk];
      if (name !== null && name !== undefined && String(name).trim() !== ''){
        const num = (val === null || val === undefined) ? null : Number(val);
        map[String(name)] = isNaN(num) ? null : num;
        foundAny = true;
      }
    }
  }
  if (!foundAny && item.param_summary){
    const pairs = String(item.param_summary).split(';');
    for (const p of pairs){
      const s = p.trim(); if (!s) continue;
      const idx = s.indexOf('='); if (idx === -1) continue;
      const k = s.slice(0, idx).trim();
      const v = s.slice(idx+1).trim();
      const num = Number(v);
      map[k] = isNaN(num) ? null : num;
    }
  }
  return map;
}

// avg1/avg2 슬롯 → 실제 기간으로 변환
function applyAvgSlotConversion(map){
  // 규칙:
  // - *_avg1 = PERIODS[slot1]
  // - *_avg2 = PERIODS[slot1 + distance] (경계 보정)
  for (const key of Object.keys(map)){
    if (!AVG_TARGETS.has(key)) continue;
    const val = map[key];
    if (val === null || Number.isNaN(Number(val))) continue;
    if (key.endsWith('_avg1')){
      const slot1 = Math.max(0, Math.min(PERIODS.length-1, Math.floor(Number(val))));
      map[key] = PERIODS[slot1];

      const key2 = key.replace('_avg1', '_avg2');
      if (key2 in map && map[key2] !== null){
        const dist = Math.floor(Number(map[key2]));
        const idx2 = Math.max(0, Math.min(PERIODS.length-1, slot1 + dist));
        map[key2]  = PERIODS[idx2];
      }
    }
  }
  return map;
}

// UPDATE SQL 생성
// ✅ UPDATE SQL 생성
// - 일반 파라미터는 그대로 col=val
// - s1m1_entry_avg1/avg2 는 env 플래그(is_s1m1_avg{period}) 0/1 로 변환
// - 다른 이평 파라미터는 건드리지 않음
function buildUpdateSQL(item, envNo){
  const raw = buildParamMap(item);
  const sets = [];

  // 1) 일반 파라미터(AVG1/AVG2 제외) → 그대로 SET
  for (const [k, v] of Object.entries(raw)){
    if (k === 's1m1_entry_avg1' || k === 's1m1_entry_avg2') continue; // 별도 처리
    if (v === null || v === undefined) continue;
    const f = fmtNum(v); if (f === null) continue;
    sets.push(`${k}=${f}`);
  }

  // 2) s1m1_entry_avg1/avg2 → is_s1m1_avg{period} 플래그로 확장
  //    slot1 = avg1 슬롯, slot2 = avg1+거리 의 슬롯
  const slot1_raw = raw['s1m1_entry_avg1'];
  const dist_raw  = raw['s1m1_entry_avg2'];

  const picked = new Set();  // 선택된 period 집합(예: {10, 40})
  if (slot1_raw !== null && slot1_raw !== undefined && !Number.isNaN(Number(slot1_raw))){
    const idx1 = Math.max(0, Math.min(PERIODS.length-1, Math.floor(Number(slot1_raw))));
    picked.add(PERIODS[idx1]);
    if (dist_raw !== null && dist_raw !== undefined && !Number.isNaN(Number(dist_raw))){
      const idx2 = Math.max(0, Math.min(PERIODS.length-1, idx1 + Math.floor(Number(dist_raw))));
      picked.add(PERIODS[idx2]);
    }
  }

  // 모든 is_s1m1_avg{period} 를 0 또는 1로 SET
  // (요구사항: 선택된 것만 1, 나머지는 모두 0)
  if (picked.size > 0){
    for (const p of PERIODS){
      const col = `is_s1m1_${'avg'}${p}`;
      const val = picked.has(p) ? 1 : 0;
      sets.push(`${col}=${val}`);
    }
  }

  if (sets.length === 0){
    return `-- No updatable parameters for env_no=${envNo}`;
  }
  return `UPDATE alpha.alpha_env SET ${sets.join(', ')} WHERE env_no=${envNo};`;
}


async function loadDetail(limit){
  const res = await fetch('/api/simul_detail?simul_id=' + simulId + '&limit=' + limit);
  if (!res.ok){ throw new Error(await res.text() || ('HTTP ' + res.status)); }
  return await res.json();
}
function matchFilter(r, token){
  if (!token) return true;
  const t = token.toLowerCase();
  return (
    String(r.case_id ?? r.gid ?? '').toLowerCase().includes(t) ||
    String(r.param_summary ?? '').toLowerCase().includes(t)
  );
}
function renderTable(items, token){
  const tbody = document.querySelector('#detailTable tbody');
  tbody.innerHTML = '';

  const filtered = items.filter(r => matchFilter(r, token));
  filtered.sort((a, b) => {
    const wa = (a.win_rate ?? -1), wb = (b.win_rate ?? -1);
    if (wb !== wa) return wb - wa;
    const pa = (a.total_profit ?? a.total_profit_ptr ?? a.profit_ptr ?? -1);
    const pb = (b.total_profit ?? b.total_profit_ptr ?? b.profit_ptr ?? -1);
    return pb - pa;
  });

  let rank = 0;
  for (const r of filtered){
    rank += 1;
    const tr = document.createElement('tr');
    tr.title = '클릭하면 UPDATE SQL을 생성합니다';
    tr.addEventListener('click', () => {

      __lastSelectedDetailRow = r;

      const envNo = parseInt(document.getElementById('envNo').value, 10) || 0;
      const sql = buildUpdateSQL(r, envNo);
      const dlg = document.getElementById('sqlDialog');
      const ta  = document.getElementById('sqlText');
      ta.value = sql;
      if (typeof dlg.showModal === 'function') dlg.showModal();
      else dlg.setAttribute('open','');
    });

    const td_rank = document.createElement('td'); td_rank.textContent = rank;
    const td_case = document.createElement('td'); td_case.textContent = r.case_id ?? r.gid ?? ''; td_case.className = 'mono';
    const td_wr   = document.createElement('td'); td_wr.textContent   = (r.win_rate != null) ? r.win_rate.toFixed(2) : ''; td_wr.className = 'right';
    const td_wc   = document.createElement('td'); td_wc.textContent   = r.wins ?? r.win_cnt ?? ''; td_wc.className = 'right';
    const td_tc   = document.createElement('td'); td_tc.textContent   = r.trades ?? r.trade_cnt ?? ''; td_tc.className = 'right';
    const profit  = (r.total_profit ?? r.total_profit_ptr ?? r.profit_ptr ?? '');
    const td_pf   = document.createElement('td'); td_pf.textContent   = profit; td_pf.className = 'right';
    const td_par  = document.createElement('td'); td_par.textContent  = r.param_summary ?? '';

    tr.appendChild(td_rank); tr.appendChild(td_case); tr.appendChild(td_wr);
    tr.appendChild(td_wc); tr.appendChild(td_tc); tr.appendChild(td_pf); tr.appendChild(td_par);
    tbody.appendChild(tr);
  }
  document.getElementById('status').textContent = 'Rows: ' + filtered.length;
}

async function reload(){
  const limitSel = document.getElementById('limit');
  const filterInput = document.getElementById('filter');
  const limit = parseInt(limitSel.value, 10);
  const status = document.getElementById('status');
  status.textContent = 'Loading...';
  try{
    const data = await loadDetail(limit);
    const items = data.items || [];
    window.__detailCache = items;
    renderTable(items, filterInput.value.trim());
  }catch(err){
    status.textContent = 'Error: ' + err.message;
    console.error(err);
  }
}

// 현재 팝업에 띄운 행을 보관 (APPLY 때 재사용)
let __lastSelectedDetailRow = null;

// 행 클릭 시 이 변수에 담도록, 기존 클릭핸들러에서 설정하세요.
// (이미 답변에서 tr.addEventListener('click', ...) 안에 SQL 생성하는 부분이 있는데,
//  그 위/아래에 아래 한 줄을 넣어주면 됩니다.)
// __lastSelectedDetailRow = r;

// ----- 슬롯 → is_s1m1_avg{period} 플래그 확장용 유틸 -----
function expandAvgFlagsFromSlots(raw){
  // slot1 = s1m1_entry_avg1, dist = s1m1_entry_avg2
  const slot1_raw = raw['s1m1_entry_avg1'];
  const dist_raw  = raw['s1m1_entry_avg2'];
  const picked = new Set();

  if (slot1_raw !== null && slot1_raw !== undefined && !Number.isNaN(Number(slot1_raw))){
    const idx1 = Math.max(0, Math.min(PERIODS.length-1, Math.floor(Number(slot1_raw))));
    picked.add(PERIODS[idx1]);
    if (dist_raw !== null && dist_raw !== undefined && !Number.isNaN(Number(dist_raw))){
      const idx2 = Math.max(0, Math.min(PERIODS.length-1, idx1 + Math.floor(Number(dist_raw))));
      picked.add(PERIODS[idx2]);
    }
  }

  // 모든 period에 대해 0/1 구성
  const flags = {};
  if (picked.size > 0){
    for (const p of PERIODS){
      flags[`is_s1m1_avg${p}`] = picked.has(p) ? 1 : 0;
    }
  }
  return flags;
}

// ----- APPLY용 payload 생성 (서버에 안전한 JSON 전송) -----
function buildApplyPayload(item, envNo){
  const raw = buildParamMap(item);

  // 1) 일반 파라미터(AVG1/AVG2 제외)
  const updates = {};
  for (const [k, v] of Object.entries(raw)){
    if (k === 's1m1_entry_avg1' || k === 's1m1_entry_avg2') continue; // 별도 처리
    if (v === null || v === undefined) continue;
    const num = Number(v);
    if (!Number.isNaN(num)) updates[k] = num;
  }

  // 2) AVG 슬롯 → is_s1m1_avg{period} 0/1 세트
  const flags = expandAvgFlagsFromSlots(raw);
  Object.assign(updates, flags);

  return { env_no: envNo, updates };
}

// ----- APPLY 버튼 핸들러 -----
const applyBtn = document.getElementById('applySqlBtn');
applyBtn.addEventListener('click', async () => {
  try{
    const item = __lastSelectedDetailRow;
    if (!item) {
      alert('No row selected.');
      return;
    }
    const envNo = parseInt(document.getElementById('envNo').value, 10) || 0;
    if (!envNo) {
      alert('Invalid env_no');
      return;
    }

    // 확인
    if (!confirm(`Apply updates to alpha.alpha_env (env_no=${envNo}) ?`)) return;

    const payload = buildApplyPayload(item, envNo);

    const res = await fetch('/api/apply_env_update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const js = await res.json().catch(() => ({}));

    if (!res.ok || !js.ok){
      const msg = js && js.error ? js.error : `HTTP ${res.status}`;
      alert('Apply failed: ' + msg + '\n(If disabled, set ALPHA_ENABLE_APPLY=1 and restart)');
      return;
    }

    alert(`Apply OK (updated ${js.rowcount} row, cols=${(js.updated_columns||[]).length})`);
  }catch(e){
    alert('Apply error: ' + (e.message || e));
  }
});










document.getElementById('reloadBtn').addEventListener('click', reload);
document.getElementById('filter').addEventListener('input', () => {
  const items = window.__detailCache || [];
  renderTable(items, document.getElementById('filter').value.trim());
});
document.getElementById('copySqlBtn').addEventListener('click', async () => {
  const ta = document.getElementById('sqlText');
  ta.select();
  try { await navigator.clipboard.writeText(ta.value); } catch(e){}
});
document.getElementById('closeSqlBtn').addEventListener('click', () => {
  const dlg = document.getElementById('sqlDialog');
  if (typeof dlg.close === 'function') dlg.close();
  else dlg.removeAttribute('open');
});
(async () => { try{ await reload(); } catch(e){ document.getElementById('status').textContent = 'Error: ' + e.message; }})();




</script>
</body>
</html>

