<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/static/app.css">
  <meta charset="UTF-8">
  <title>Simulation Regist</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    nav { background:#343a40; padding:10px; display:flex; gap:20px; }
    nav a { color:#fff; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .container { padding:16px; }
    .row { display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap; }
    .card { background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:14px; }
    .card .input { font-size: 14px; }
    .card select.input { font-size: 12px; padding: 7px 12px; height: auto; }

    .card h3 { margin:4px 0 10px 0; font-size:16px; }
    .grid { display:grid; grid-template-columns:repeat(6, 1fr); gap:10px; }
    .grid .col-2 { grid-column: span 2; }
    .grid .col-3 { grid-column: span 3; }
    label { font-size:12px; color:#333; display:block; margin-bottom:4px; }
    input[type="number"], input[type="text"], select {
      width:100%; padding:6px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px;
    }
    input[readonly] { background:#eee; }
    .btnbar { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    button { padding:7px 12px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
    button.primary { background:#2b7cff; color:#fff; border-color:#2b7cff; }
    button.danger  { background:#e74c3c; color:#fff; border-color:#e74c3c; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e3e3e3; padding:6px 8px; font-size:13px; }
    tr:hover { background:#f1f5ff; cursor:pointer; }
    .badge { padding:2px 6px; border-radius:10px; font-size:11px; }
    .on { background:#d1fae5; color:#065f46; }
    .off { background:#fee2e2; color:#7f1d1d; }
    .total { font-weight:bold; color:#222; }
    .muted { color:#666; font-size:12px; }
    .nav-center { display: flex; justify-content: center; }
    .right { text-align:right; }
    .left { text-align:left; }

    /* 기본: 행에 지정한 --row-color를 모든 셀에 적용 */
    #simulTable tbody tr.data-row td { color: var(--row-color, inherit); }
    #simulTable tbody tr.data-row a { color: inherit; }

    /* 혹시 다른 스타일이 더 세면 이걸로 강제 */
    #simulTable tbody tr[data-state="1"] td { color: green !important; }
    #simulTable tbody tr[data-state="3"] td,
    #simulTable tbody tr[data-state="4"] td { color: red !important; }
    #simulTable tbody tr[data-state="1"] a,
    #simulTable tbody tr[data-state="3"] a,
    #simulTable tbody tr[data-state="4"] a { color: inherit !important; }

  </style>
</head>
<body>

<nav class="nav-center">
  <a href="/">Alpha Cuda</a>
  <a href="/cuda">Simulations</a>
  <a href="/simul">New Simulation</a>
  <a href="/paramset">Param Sets</a>
</nav>

<div class="container">
    <h4 style="margin: 8px 0 10px 2px;">Alpha Cuda :: Simulation Regist</h4>

    <div class="card">

      <div class="form-grid">
        <div class="field" >
          <label for="f_id">simul_id</label>
          <input id="f_id" class="input" type="number">
        </div>

        <div class="field">
          <label for="f_name">simul_name</label>
          <input id="f_name" class="input" type="text">
        </div>

        <div class="field">
          <label for="f_type">simul_type</label>
          <select id="f_type" class="input">
            <option value="0">기본전략</option>
            <option value="1">혼잡도 조합</option>
          </select>
        </div>

        <div class="field">
          <label for="f_param">param_set_id</label>
          <input id="f_param" class="input" type="number">
        </div>

        <div class="field w2">
          <label for="f_desc">simul_desc</label>
          <input id="f_desc" class="input" type="text">
        </div>

        <div class="field">
          <label for="f_from">from</label>
          <input id="f_from" class="input" type="text" placeholder="yyyyMMddHHmmss">
        </div>

        <div class="field">
          <label for="f_to">to</label>
          <input id="f_to" class="input" type="text" placeholder="yyyyMMddHHmmss">
        </div>


        <div>
          <label for="f_candle">simul_candle</label>
          <input id="f_candle" class="input" type="number" />
        </div>

        <div class="field">
          <label for="f_reason">reason</label>
          <input id="f_reason" class="input" type="text" >
        </div>
        <div  class="field">
          <label for="f_main">main_simul_id</label>
          <input id="f_main" class="input" type="number" />
        </div>

        <div>
          <label for="f_top">main_simul_gid</label>
          <input id="f_top" class="input" type="number" />
        </div>


        <div> </div>
        <div class="btnbar field-buttons">
          <button id="btnAdd" class="primary btn lg">Add</button>
          <button id="btnSave" class="primary btn lg">Save</button>
          <button id="btnClear" class="btn lg">Clear</button>
          <button id="btnReload" class="btn lg">Reload</button>
        </div>

        <div class="field">
          <label for="f_status">status</label>
          <select id="f_status" class="input">
            <option value="0">Ready</option>
            <option value="1">Running</option>
            <option value="2">Done</option>
            <option value="3">Stop</option>
            <option value="4">Error</option>
          </select>
        </div>

        <div class="field">
          <label for="f_active">active</label>
          <select id="f_active" class="input">
            <option value="1">활성</option>
            <option value="0">비활성</option>
          </select>
        </div>
      </div>


    </div>

    <!-- 리스트 -->
    <div class="card" >
      <table id="tbl">
        <thead>
          <tr>
            <th class="right">id</th>
            <th class="right">simul_type</th>
            <th class="right">m.id</th>
            <th class="right">m.gid</th>
            <th class="left">simul name</th>
            <th class="right">reg time</th>
            <th class="right">from</th>
            <th class="right">to</th>
            <th class="right">psid</th>  <!-- param_set_id -->
            <th class="right">active</th>
            <th class="right">status</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== DOM 캐싱 (폼 요소/버튼들) =====
  const f_id     = document.getElementById('f_id');
  const f_name   = document.getElementById('f_name');
  const f_desc   = document.getElementById('f_desc');
  const f_from   = document.getElementById('f_from');
  const f_to     = document.getElementById('f_to');
  const f_candle = document.getElementById('f_candle');
  const f_type   = document.getElementById('f_type');
  const f_main   = document.getElementById('f_main');
  const f_top    = document.getElementById('f_top');
  const f_param  = document.getElementById('f_param');
  const f_active = document.getElementById('f_active');
  const f_status = document.getElementById('f_status');
  const f_reason = document.getElementById('f_reason');

  const btnAdd    = document.getElementById('btnAdd');
  const btnSave   = document.getElementById('btnSave');   // ← id 오타 주의(“sava” X)
  const btnClear  = document.getElementById('btnClear');
  const btnReload = document.getElementById('btnReload');

  const tbody = document.querySelector('#tbl tbody');


  // ===== 공용 헬퍼 =====
  async function api(url, init = {}) {
    const res = await fetch(url, {
      headers: {'Content-Type': 'application/json'},
      ...init
    });
    const js = await res.json().catch(() => ({}));
    if (!res.ok || js.ok === false) {
      throw new Error(js.error || res.statusText);
    }
    return js;
  }
  const typeName   = (t) => Number(t) === 1 ? '혼잡도 조합' : '기본전략';


  const activeBadge = (a) => {
  const on = Number(a) === 1;
  return `<span class="badge ${on ? 'on' : 'off'}" title="${on ? '활성' : '비활성'}">${on ? 'ON' : 'OFF'}</span>`;
};


function rowHtml(r){
  const sid   = (r.simul_id ?? '') + '';
  const typeV = Number(r.simul_type ?? 0); const typeS = typeName(typeV);
  const mid   = (r.main_simul_id ?? '') + '';
  const mgid  = (r.main_simul_gid ?? '') + '';
  const name  = r.simul_name || '';
  const regS  = r.reg_time || '';
  const fromS = r.simul_from_date || '';
  const toS   = r.simul_to_date || '';
  const pid   = (r.param_set_id ?? '-') + '';
  const actV  = Number(r.is_active) === 1 ? 1 : 0;
  const actHtml = activeBadge(actV);

  const statusV = Number(r.status ?? 0);
  const status =
      statusV === 0 ? "Ready"   :
      statusV === 1 ? "Running" :
      statusV === 2 ? "Done"    :
      statusV === 3 ? "Stop"    :
      statusV === 4 ? "Error"   : "";

  // ★ 상태별 글자색(인라인 + !important) — 덮어쓰임 방지
  const tdAttr =
      statusV === 1 ? ' style="color:#0a7b00 !important;"' :
      (statusV === 3 || statusV === 4) ? ' style="color:#b00020 !important;"' :
      '';
  // 링크 색도 행 색을 따르게 강제
  const aAttr = tdAttr ? ' style="color:inherit !important;"' : '';

  // 히든 항목들
  const candle = r.simul_candle ?? '';
  const desc   = (r.simul_desc || '').replace(/"/g, '&quot;');
  const main   = r.main_simul_id ?? '';
  const top    = r.main_simul_gid ?? '';
  const reason = (r.reason || '').replace(/"/g, '&quot;');

  return `<tr
    class="data-row"
    data-id="${sid}"
    data-name="${name.replace(/"/g, '&quot;')}"
    data-type="${typeV}"
    data-from="${fromS}"
    data-to="${toS}"
    data-param="${pid === '-' ? '' : pid}"
    data-active="${actV}"
    data-status="${status}"
    data-state="${statusV}"
    data-candle="${candle}"
    data-desc="${desc}"
    data-main="${main}"
    data-top="${top}"
    data-reason="${reason}"
  >
    <td class="right"${tdAttr}>
      <a href="/cuda/${sid}"${aAttr}>${sid}</a>
    </td>
    <td class="right"${tdAttr}>${typeS}</td>
    <td class="right"${tdAttr}>${mid}</td>
    <td class="right"${tdAttr}>${mgid}</td>
    <td${tdAttr}>${name}</td>
    <td class="right"${tdAttr}>${regS}</td>
    <td class="right"${tdAttr}>${fromS}</td>
    <td class="right"${tdAttr}>${toS}</td>
    <td class="right"${tdAttr}>${pid}</td>
    <td class="right"${tdAttr}>${actHtml}</td>  <!-- 뱃지 안쪽 스타일이 있으면 그게 우선될 수 있음 -->
    <td class="right status"${tdAttr}>${status}</td>
  </tr>`;
}


  function fillFormFromRow(tr){
    const tds = tr.children;
    const idText   = (tds[0]?.innerText || '').trim();
    const nameText = (tds[4]?.innerText || '').trim();
    const typeText = (tds[1]?.innerText || '').trim();
    //const period   = (tds[6]?.innerText || '').trim();
    const fromDt   = (tds[6]?.innerText || '').trim();
    const toDt     = (tds[7]?.innerText || '').trim();
    const pidText  = (tds[8]?.innerText || '').trim();
    const actText  = (tds[9]?.innerText || '').trim();
    const stText   = (tds[10]?.innerText || '').trim();
    const d = tr.dataset;

    f_id.value   = idText ? Number(idText) : '';
    f_name.value = nameText;
    f_type.value = (typeText.includes('기본전략')) ? '0' : '1';

    //const parts = period.split('~');
    //f_from.value = (parts[0]||'').trim();
    //f_to.value   = (parts[1]||'').trim();
    f_from.value = fromDt;
    f_to.value   = toDt;

    f_param.value  = (pidText === '-' ? '' : pidText);
    //f_active.value = (actText.includes('(1)')) ? '1' : '0';

    f_active.value = d.active || '1';
    // is_active (dataset 우선, 없으면 뱃지 클래스 판독)
    //const badge   = tds[6]?.querySelector('.badge');
    //const actViaBadge = badge ? (badge.classList.contains('on') ? '1' : '0') : undefined;
    //f_active.value = d.active ?? actViaBadge ?? '1';

    //console.log("d.status =", d.status, " (row id:", idText, ")");

    f_status.value = '0';
    if(d.status =='Ready') f_status.value = '0';
    if(d.status =='Running') f_status.value = '1';
    if(d.status =='Done') f_status.value = '2';
    if(d.status =='Stop') f_status.value = '3';
    if(d.status =='Error') f_status.value = '4';
    //f_status.value = d.status || '1';

    f_candle.value = d.candle ?? '';
    f_desc.value   = d.desc   ?? '';
    f_main.value   = d.main   ?? '';
    f_top.value    = d.top    ?? '';
    f_reason.value = d.reason ?? '';
  }

  async function fetchSimulList(){
    // 목록은 검증된 API 사용
    const js = await api('/api/simul_list?limit=1000', { method: 'GET' });
    return js.items || [];
  }

  //
  // Reload List
  //
  async function reloadList()
  {
    const items = await fetchSimulList();
    tbody.innerHTML = items.map(rowHtml).join('');

    const first = tbody.querySelector('tr');
    if (first) fillFormFromRow(first);
  }

  function clearForm(){
    f_id.value = '';
    f_name.value = '';
    f_desc.value = '';
    f_from.value = '';
    f_to.value = '';
    f_candle.value = '';
    f_type.value = '0';
    f_main.value = '';
    f_top.value = '';
    f_param.value = '';
    f_active.value = '1';
    f_status.value = '0';
    f_reason.value = '';
  }

  async function addSimul(){
    const payload = {
      simul_id:        Number(f_id.value),
      simul_name:      f_name.value,
      simul_desc:      f_desc.value,
      simul_from_date: f_from.value,
      simul_to_date:   f_to.value,
      simul_candle:    f_candle.value ? Number(f_candle.value) : null,
      simul_type:      Number(f_type.value),
      main_simul_id:   f_main.value ? Number(f_main.value) : null,
      main_simul_gid:  f_top.value ? Number(f_top.value) : null,
      param_set_id:    f_param.value ? Number(f_param.value) : null,
      is_active:       Number(f_active.value),
      status:          Number(f_status.value),
      reason:          f_reason.value
    };
    const js = await api('/api/simulation', { method: 'POST', body: JSON.stringify(payload) });
    alert('Inserted simul_id=' + js.simul_id);
    await reloadList();
    clearForm();
  }

  async function saveSimul(){
    if (!f_id.value) { alert('Select a row or input simul_id.'); return; }
    const payload = {
      simul_id:        Number(f_id.value),
      simul_name:      f_name.value,
      simul_desc:      f_desc.value,
      simul_from_date: f_from.value,
      simul_to_date:   f_to.value,
      simul_candle:    f_candle.value ? Number(f_candle.value) : null,
      simul_type:      Number(f_type.value),
      main_simul_id:   f_main.value ? Number(f_main.value) : null,
      main_simul_gid:  f_top.value ? Number(f_top.value) : null,
      param_set_id:    f_param.value ? Number(f_param.value) : null,
      is_active:       Number(f_active.value),
      status:          Number(f_status.value),
      reason:          f_reason.value
    };
    await api('/api/simulation', { method: 'PUT', body: JSON.stringify(payload) });
    alert('Saved.');
    await reloadList();
  }

  // ===== 이벤트 바인딩 =====
  // 테이블 행 클릭 → 폼 채우기
  tbody.addEventListener('click', (e) => {
    const tr = e.target.closest('tr');
    if (tr) fillFormFromRow(tr);
  });

  // 버튼들 (폼 submit 막기 위해 preventDefault + 버튼 type="button" 권장)
  btnAdd?.addEventListener('click',  (e) => { e.preventDefault(); addSimul().catch(err => alert(err.message)); });
  btnSave?.addEventListener('click', (e) => { e.preventDefault(); saveSimul().catch(err => alert(err.message)); });
  btnClear?.addEventListener('click',(e) => { e.preventDefault(); clearForm(); });
  btnReload?.addEventListener('click',(e) => { e.preventDefault(); reloadList().catch(err => alert(err.message)); });

  // ===== 최초 로드 (이제 안전) =====
  reloadList().catch(err => {
    console.error(err);
    alert('List load failed: ' + err.message);
  });
});
</script>





</body>
</html>

