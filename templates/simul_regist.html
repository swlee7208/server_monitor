<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simulation Regist</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    nav { background:#343a40; padding:10px; display:flex; gap:20px; }
    nav a { color:#fff; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .container { padding:16px; }
    .row { display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap; }
    .card { background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:14px; }
    .card h3 { margin:4px 0 10px 0; font-size:16px; }
    .grid { display:grid; grid-template-columns:repeat(6, 1fr); gap:10px; }
    .grid .col-2 { grid-column: span 2; }
    .grid .col-3 { grid-column: span 3; }
    label { font-size:12px; color:#333; display:block; margin-bottom:4px; }
    input[type="number"], input[type="text"], select {
      width:100%; padding:6px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px;
    }
    input[readonly] { background:#eee; }
    .btnbar { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    button { padding:7px 12px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
    button.primary { background:#2b7cff; color:#fff; border-color:#2b7cff; }
    button.danger  { background:#e74c3c; color:#fff; border-color:#e74c3c; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e3e3e3; padding:6px 8px; font-size:13px; }
    tr:hover { background:#f1f5ff; cursor:pointer; }
    .badge { padding:2px 6px; border-radius:10px; font-size:11px; }
    .on { background:#d1fae5; color:#065f46; }
    .off { background:#fee2e2; color:#7f1d1d; }
    .total { font-weight:bold; color:#222; }
    .muted { color:#666; font-size:12px; }
    .nav-center { display: flex; justify-content: center; }
  </style>
  <link rel="stylesheet" href="/static/app.css">
</head>
<body>
<nav class="nav-center">
    <a href="/">Monitoring</a>
    <a href="/cuda">Cuda Simul</a>
    <a href="/simul">Simul Reg</a>
    <a href="/paramset">Param Reg</a>
</nav>


<div class="container">

    <div class="card">
      <h3>Simulation Regist</h3>

      <div class="form-grid">
        <div class="field">
          <label for="f_id">simul_id</label>
          <input id="f_id" class="input" type="number">
        </div>

        <div class="field">
          <label for="f_name">simul_name</label>
          <input id="f_name" class="input" type="text">
        </div>

        <div class="field">
          <label for="f_type">simul_type</label>
          <select id="f_type" class="input">
            <option value="0">기본전략</option>
            <option value="1">혼잡도 조합</option>
          </select>
        </div>

        <div class="field">
          <label for="f_param">param_set_id</label>
          <input id="f_param" class="input" type="number">
        </div>

        <div class="field w2">
          <label for="f_desc">simul_desc</label>
          <input id="f_desc" class="input" type="text">
        </div>

        <div class="field">
          <label for="f_from">from</label>
          <input id="f_from" class="input" type="text" placeholder="yyyyMMddHHmmss">
        </div>

        <div class="field">
          <label for="f_to">to</label>
          <input id="f_to" class="input" type="text" placeholder="yyyyMMddHHmmss">
        </div>


        <div>
          <label for="f_candle">simul_candle</label>
          <input id="f_candle" type="number" placeholder="ex) 1" />
        </div>

        <div>
          <label for="f_main">main_simul_id</label>
          <input id="f_main" type="number" />
        </div>

        <div>
          <label for="f_top">main_top_rank</label>
          <input id="f_top" type="number" />
        </div>




        <div class="col-2">
          <label for="f_reason">reason</label>
          <input id="f_reason" type="text" placeholder="변경 사유 / 메모" />
        </div>


        <div class="field">
          <label for="f_active">is_active</label>
          <select id="f_active" class="input">
            <option value="1">활성</option>
            <option value="0">비활성</option>
          </select>
        </div>
      </div>

      <div class="btnbar">
        <button id="btnAdd"    class="btn" type="button">Add</button>
        <button id="btnSave"   class="btn primary" type="button">Save</button>
        <button id="btnClear"  class="btn" type="button">Clear</button>
        <button id="btnReload" class="btn" type="button">Reload</button>
      </div>



    </div>

    <!-- 리스트 -->
    <div class="card" >
      <h3>시뮬레이션 리스트</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th>simul_id</th>
            <th>simul_name</th>
            <th>simul_type</th>
            <th>reg_time</th>
            <th>simul_from_date ~ simul_to_date</th>
            <th>param_set_id</th>  <!-- NEW -->
            <th>is_active</th>     <!-- NEW -->
            <th>status</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== DOM 캐싱 (폼 요소/버튼들) =====
  const f_id     = document.getElementById('f_id');
  const f_name   = document.getElementById('f_name');
  const f_desc   = document.getElementById('f_desc');
  const f_from   = document.getElementById('f_from');
  const f_to     = document.getElementById('f_to');
  const f_candle = document.getElementById('f_candle');
  const f_type   = document.getElementById('f_type');
  const f_main   = document.getElementById('f_main');
  const f_top    = document.getElementById('f_top');
  const f_param  = document.getElementById('f_param');
  const f_active = document.getElementById('f_active');
  const f_reason = document.getElementById('f_reason');

  const btnAdd    = document.getElementById('btnAdd');
  const btnSave   = document.getElementById('btnSave');   // ← id 오타 주의(“sava” X)
  const btnClear  = document.getElementById('btnClear');
  const btnReload = document.getElementById('btnReload');

  const tbody = document.querySelector('#tbl tbody');


  // ===== 공용 헬퍼 =====
  async function api(url, init = {}) {
    const res = await fetch(url, {
      headers: {'Content-Type': 'application/json'},
      ...init
    });
    const js = await res.json().catch(() => ({}));
    if (!res.ok || js.ok === false) {
      throw new Error(js.error || res.statusText);
    }
    return js;
  }
  const typeName   = (t) => Number(t) === 1 ? '혼잡도 조합' : '기본전략';


  const activeBadge = (a) => {
  const on = Number(a) === 1;
  return `<span class="badge ${on ? 'on' : 'off'}" title="${on ? '활성' : '비활성'}">${on ? 'ON' : 'OFF'}</span>`;
};

function rowHtml(r){
  const sid   = (r.simul_id ?? '') + '';
  const name  = r.simul_name || '';
  const typeV = Number(r.simul_type ?? 0);
  const typeS = typeName(typeV);
  const regS  = r.reg_time || '';
  const fromS = r.simul_from_date || '';
  const toS   = r.simul_to_date || '';
  const span  = (fromS && toS) ? `${fromS} ~ ${toS}` : (fromS || toS);
  const pid   = (r.param_set_id ?? '-') + '';
  const actV  = Number(r.is_active) === 1 ? 1 : 0;
  const actHtml = activeBadge(actV);
  const status= (r.status ?? '') + '';

  // 히든 항목들
  const candle = r.simul_candle ?? '';
  const desc   = (r.simul_desc || '').replace(/"/g, '&quot;');
  const main   = r.main_simul_id ?? '';
  const top    = r.main_top_rank ?? '';

  return `<tr
    data-id="${sid}"
    data-name="${name.replace(/"/g, '&quot;')}"
    data-type="${typeV}"
    data-from="${fromS}"
    data-to="${toS}"
    data-param="${pid === '-' ? '' : pid}"
    data-active="${actV}"
    data-candle="${candle}"
    data-desc="${desc}"
    data-main="${main}"
    data-top="${top}"
  >
    <td>${sid}</td>
    <td>${name}</td>
    <td>${typeS}</td>
    <td class="small">${regS}</td>
    <td class="small">${span}</td>
    <td>${pid}</td>
    <td>${actHtml}</td>     <!-- ← 뱃지 표시 -->
    <td>${status}</td>
  </tr>`;
}


  function fillFormFromRow(tr){
    const tds = tr.children;
    const idText   = (tds[0]?.innerText || '').trim();
    const nameText = (tds[1]?.innerText || '').trim();
    const typeText = (tds[2]?.innerText || '').trim();
    const period   = (tds[4]?.innerText || '').trim();
    const pidText  = (tds[5]?.innerText || '').trim();
    const actText  = (tds[6]?.innerText || '').trim();
    const d = tr.dataset;

    f_id.value   = idText ? Number(idText) : '';
    f_name.value = nameText;
    f_type.value = (typeText.includes('(1)')) ? '1' : '0';

    const parts = period.split('~');
    f_from.value = (parts[0]||'').trim();
    f_to.value   = (parts[1]||'').trim();

    f_param.value  = (pidText === '-' ? '' : pidText);
    //f_active.value = (actText.includes('(1)')) ? '1' : '0';

    f_active.value = d.active || '1';
    // is_active (dataset 우선, 없으면 뱃지 클래스 판독)
    //const badge   = tds[6]?.querySelector('.badge');
    //const actViaBadge = badge ? (badge.classList.contains('on') ? '1' : '0') : undefined;
    //f_active.value = d.active ?? actViaBadge ?? '1';

    f_candle.value = d.candle ?? '';
    f_desc.value   = d.desc   ?? '';
    f_main.value   = d.main   ?? '';
    f_top.value    = d.top    ?? '';
  }

  async function fetchSimulList(){
    // 목록은 검증된 API 사용
    const js = await api('/api/simul_list?limit=1000', { method: 'GET' });
    return js.items || [];
  }

  async function reloadList(){
    const items = await fetchSimulList();
    tbody.innerHTML = items.map(rowHtml).join('');
    const first = tbody.querySelector('tr');
    if (first) fillFormFromRow(first);
  }

  function clearForm(){
    f_id.value = '';
    f_name.value = '';
    f_desc.value = '';
    f_from.value = '';
    f_to.value = '';
    f_candle.value = '';
    f_type.value = '0';
    f_main.value = '';
    f_top.value = '';
    f_param.value = '';
    f_active.value = '1';
    f_reason.value = '';
  }

  async function addSimul(){
    const payload = {
      simul_id:        Number(f_id.value),
      simul_name:      f_name.value,
      simul_desc:      f_desc.value,
      simul_from_date: f_from.value,
      simul_to_date:   f_to.value,
      simul_candle:    f_candle.value ? Number(f_candle.value) : null,
      simul_type:      Number(f_type.value),
      main_simul_id:   f_main.value ? Number(f_main.value) : null,
      main_top_rank:   f_top.value ? Number(f_top.value) : null,
      param_set_id:    f_param.value ? Number(f_param.value) : null,
      is_active:       Number(f_active.value),
      reason:          f_reason.value
    };
    const js = await api('/api/simulation', { method: 'POST', body: JSON.stringify(payload) });
    alert('Inserted simul_id=' + js.simul_id);
    await reloadList();
    clearForm();
  }

  async function saveSimul(){
    if (!f_id.value) { alert('Select a row or input simul_id.'); return; }
    const payload = {
      simul_id:        Number(f_id.value),
      simul_name:      f_name.value,
      simul_desc:      f_desc.value,
      simul_from_date: f_from.value,
      simul_to_date:   f_to.value,
      simul_candle:    f_candle.value ? Number(f_candle.value) : null,
      simul_type:      Number(f_type.value),
      main_simul_id:   f_main.value ? Number(f_main.value) : null,
      main_top_rank:   f_top.value ? Number(f_top.value) : null,
      param_set_id:    f_param.value ? Number(f_param.value) : null,
      is_active:       Number(f_active.value),
      reason:          f_reason.value
    };
    await api('/api/simulation', { method: 'PUT', body: JSON.stringify(payload) });
    alert('Saved.');
    await reloadList();
  }

  // ===== 이벤트 바인딩 =====
  // 테이블 행 클릭 → 폼 채우기
  tbody.addEventListener('click', (e) => {
    const tr = e.target.closest('tr');
    if (tr) fillFormFromRow(tr);
  });

  // 버튼들 (폼 submit 막기 위해 preventDefault + 버튼 type="button" 권장)
  btnAdd?.addEventListener('click',  (e) => { e.preventDefault(); addSimul().catch(err => alert(err.message)); });
  btnSave?.addEventListener('click', (e) => { e.preventDefault(); saveSimul().catch(err => alert(err.message)); });
  btnClear?.addEventListener('click',(e) => { e.preventDefault(); clearForm(); });
  btnReload?.addEventListener('click',(e) => { e.preventDefault(); reloadList().catch(err => alert(err.message)); });

  // ===== 최초 로드 (이제 안전) =====
  reloadList().catch(err => {
    console.error(err);
    alert('List load failed: ' + err.message);
  });
});
</script>





</body>
</html>

