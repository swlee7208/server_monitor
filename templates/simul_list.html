<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/static/app.css">
  <meta charset="UTF-8">
  <title>Alpha Cuda Simul</title>
  <style>
    /* === paramset.html 스타일과 일치 === */
    body { font-family: Arial, sans-serif; margin: 0; }
    nav { background:#343a40; padding:10px; display:flex; gap:20px; }
    nav a { color:#fff; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }

    .container { padding:16px; }                 /* 동일 */
    .row { display:flex; gap:16px;               /* 상단 입력부 레이아웃 */
            align-items:flex-end; flex-wrap:wrap; }
    .card { background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:14px; }
    .card .input { font-size: 14px; }
    .card select.input { font-size: 12px; padding: 7px 12px; height: auto; }
    .card h3 { margin:4px 0 10px 0; font-size:16px; }

    label { font-size:12px; color:#333; display:block; margin-bottom:4px; }
    input[type="text"], select {
      width:100%; padding:6px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px;
    }

    .btnbar { display:flex; gap:8px; margin-top:0; flex-wrap:wrap; }
    button { padding:7px 12px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
    button.primary { background:#2b7cff; color:#fff; border-color:#2b7cff; }

    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e3e3e3; padding:6px 8px; font-size:13px; }
    th { text-align:left; background:#f5f6f7; }
    tr:hover { background:#f1f5ff; cursor:pointer; }

    .right { text-align:right; }
    .muted { color:#666; font-size:12px; }
    .nav-center { display: flex; justify-content: center; }
    #simulTable tbody tr.row--running td { color: green; } /* 연한 초록 */
    #simulTable tbody tr.row--stopped td,
    #simulTable tbody tr.row--error  td { color: red; }   /* 연한 빨강 */
  </style>
</head>
<body>

<nav class="nav-center">
  <a href="/">Alpha Cuda</a>
  <a href="/cuda">Simulations</a>
  <a href="/simul">New Simulation</a>
  <a href="/paramset">Param Sets</a>
</nav>

<div class="container">
  <h4 style="margin: 8px 0 10px 2px;">Alpha Cuda :: Simulation List</h4>

  <!-- 상단 입력부: paramset과 동일한 카드/row 구성 -->
  <div class="card">
    <div class="row">
      <div>
        <label>Max Rows</label>
        <select id="limit" class="input">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
          <option value="500">500</option>
          <option value="1000">1000</option>
        </select>
      </div>

      <div style="min-width:240px;">
        <label>Filter (Name / Type / ID)</label>
        <input type="text" id="filter"  class="input">
      </div>

      <div>
        <label>&nbsp;</label>
        <div class="btnbar">
          <button id="reloadBtn" class="primary btn lg">Reload</button>
        </div>
      </div>

      <div style="margin-left:auto">
        <div class="muted" id="status">Rows: 0</div>
      </div>
    </div>
  </div>

  <!-- 리스트: paramset 테이블 스타일로 통일 -->
  <div class="card">
    <table id="simulTable">
      <thead>
        <tr>
          <th>id</th>
          <th>simul type</th>
          <th class="right">m.id</th>
          <th class="right">m.gid</th>
          <th>simul name</th>
          <th class="right">from</th>
          <th class="right">to</th>
          <th class="right">case</th>
          <th class="right">start</th>
          <th class="right">finish</th>
          <th class="right">progress</th>
          <th class="right">status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
async function loadSimulList(limit){
  const res = await fetch('/api/simul_list?limit=' + limit);
  if (!res.ok){ throw new Error(await res.text() || ('HTTP ' + res.status)); }
  return await res.json();
}

function matchFilter(row, token){
  if (!token) return true;
  const t = token.toLowerCase();
  return (
    String(row.simul_id ?? '').toLowerCase().includes(t) ||
    String(row.simul_type ?? '').toLowerCase().includes(t) ||
    String(row.main_simul_id ?? '').toLowerCase().includes(t) ||
    String(row.simul_name ?? '').toLowerCase().includes(t)
  );
}

function renderTable(items, token){
  const tbody = document.querySelector('#simulTable tbody');
  tbody.innerHTML = '';

  const filtered = items.filter(r => matchFilter(r, token));

  // 상태 라벨 매핑
  const statusLabel = { 0: 'Ready', 1: 'Running', 2: 'Done', 3: 'Stop', 4: 'Error' };

  for (const r of filtered){
    const tr = document.createElement('tr');
    tr.className = 'data-row';

    // 상태에 따른 행 색상
    switch (r.status) {
      case 1: // Running
        tr.classList.add('row--running');
        break;
      case 3: // Stop
        tr.classList.add('row--stopped');
        break;
      case 4: // Error
        tr.classList.add('row--error');
        break;
      // 0(Ready), 2(Done)은 원래색 → 아무 클래스도 추가하지 않음
    }

    // 행 클릭 → 상세 페이지 이동
    tr.addEventListener('click', () => {
      if (r.simul_id != null) {
        const name = encodeURIComponent(r.simul_name ?? '');
        window.location.href = `/cuda/${r.simul_id}?simul_name=${name}`;
      }
    });

    // 첫 셀 링크(백업)
    const td_id = document.createElement('td');
    const a = document.createElement('a');
    a.href = '/cuda/' + (r.simul_id ?? '');
    a.textContent = r.simul_id ?? '';
    td_id.appendChild(a);

    const td_type = document.createElement('td'); td_type.textContent = r.simul_type === 0 ? "주전략" : (r.simul_type === 1 ? "혼잡도조합" : "");
    const td_pid  = document.createElement('td'); td_pid.textContent  = r.main_simul_id ?? '';
    td_pid.classList.add("right");
    const td_gid  = document.createElement('td'); td_gid.textContent  = r.main_simul_gid ?? '';
    td_gid.classList.add("right");
    const td_name = document.createElement('td'); td_name.textContent = r.simul_name ?? '';
    const td_fd   = document.createElement('td'); td_fd.textContent   = r.simul_from_date ?? '';
    td_fd.classList.add("right");
    const td_td   = document.createElement('td'); td_td.textContent   = r.simul_to_date ?? '';
    td_td.classList.add("right");
    const td_case = document.createElement('td'); td_case.textContent = r.case_cnt ?? '';
    td_case.classList.add("right");
    const td_start= document.createElement('td'); td_start.textContent= r.start_time ?? '';
    td_start.classList.add("right");
    const td_end  = document.createElement('td'); td_end.textContent  = r.end_time ?? '';
    td_end.classList.add("right");
    const td_prs  = document.createElement('td');
    td_prs.classList.add("right");
    if (r.progress != null) {
      td_prs.textContent = `${Math.floor(r.progress)} %`;
    } else {
      td_prs.textContent = '';
    }

    const td_st   = document.createElement('td');
    td_st.classList.add("right");
    td_st.textContent = statusLabel[r.status] ?? '';

    tr.appendChild(td_id);
    tr.appendChild(td_type);
    tr.appendChild(td_pid);
    tr.appendChild(td_gid);
    tr.appendChild(td_name);
    tr.appendChild(td_fd);
    tr.appendChild(td_td);
    tr.appendChild(td_case);
    tr.appendChild(td_start);
    tr.appendChild(td_end);
    tr.appendChild(td_prs);
    tr.appendChild(td_st);

    tbody.appendChild(tr);
  }
  document.getElementById('status').textContent = 'Rows: ' + filtered.length;
}


async function reload(){
  const limitSel = document.getElementById('limit');
  const filterInput = document.getElementById('filter');
  const limit = parseInt(limitSel.value, 10);
  const status = document.getElementById('status');
  status.textContent = 'Loading...';

  try{
    const data = await loadSimulList(limit);
    const items = data.items || [];
    window.__lastItems = items; // 필터링 캐시
    renderTable(items, filterInput.value.trim());
    status.textContent = 'Rows: ' + items.length;
  }catch(err){
    status.textContent = 'Error: ' + err.message;
    console.error(err);
  }
}

document.getElementById('reloadBtn').addEventListener('click', reload);
document.getElementById('filter').addEventListener('input', () => {
  const items = window.__lastItems || [];
  renderTable(items, document.getElementById('filter').value.trim());
});

// 초기 로딩
(async () => {
  try{
    await reload();
  }catch(e){
    document.getElementById('status').textContent = 'Error: ' + e.message;
  }
})();
</script>
</body>
</html>

